#!/usr/bin/env python

# ================================================================================
# =                                     TBAK                                     =
# ================================================================================

# Creates numbered tar backups of directories.

import argparse
import re
import sys
import tarfile
from pathlib import Path


def tbak(
    backup_dir: Path | str, output_dir: Path | str = Path.cwd(), compression: str = "gz"
) -> None:
    backup_dir = Path(backup_dir)
    output_dir = Path(output_dir)

    # Validate directories exist
    if not backup_dir.exists():
        raise FileNotFoundError(f"Backup directory not found: {backup_dir}")
    if not backup_dir.is_dir():
        raise NotADirectoryError(f"Not a directory: {backup_dir}")
    if not output_dir.exists():
        raise FileNotFoundError(f"Output directory not found: {output_dir}")
    if not output_dir.is_dir():
        raise NotADirectoryError(f"Not a directory: {output_dir}")

    # Find highest existing backup number
    pattern = re.compile(rf"^{re.escape(backup_dir.name)}_(\d+)\.tar.{compression}$")
    backup_numbers = []

    for file in output_dir.iterdir():
        if file.is_file() and (match := pattern.search(file.name)):
            backup_numbers.append(int(match.group(1)))

    # Determine backup name
    next_num = max(backup_numbers, default=0) + 1
    backup_name = f"{backup_dir.name}_{next_num}.tar.{compression}"

    # Create tar file
    with tarfile.open(output_dir / backup_name, f"w:{compression}") as tarf:  # type: ignore[arg-type]
        for directory, _, files in backup_dir.walk():
            for file in files:
                tarf.add(directory / file)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Create numbered tar backup of directory"
    )
    parser.add_argument("backup_dir", type=Path, help="Directory to backup")
    parser.add_argument(
        "-o",
        "--output-dir",
        default=Path.cwd(),
        type=Path,
        help="Directory to store backup",
    )
    parser.add_argument(
        "-c",
        "--compression",
        default="gz",
        choices=["gz", "bz2", "xz"],
        help="Compression algorithim to use",
    )
    args = parser.parse_args()

    try:
        tbak(args.backup_dir, args.output_dir, args.compression)
    except (FileNotFoundError, NotADirectoryError) as e:
        print(f"Error: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"Unexpected error: {e}")
        sys.exit(1)
