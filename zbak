#!/usr/bin/env python

# ================================================================================
# =                                     ZBAK                                     =
# ================================================================================

# Creates numbered zip backups of directories.

import argparse
import re
import sys
import zipfile
from pathlib import Path


def zbak(backup_dir: Path | str, output_dir: Path | str = Path.cwd()) -> None:
    backup_dir = Path(backup_dir)
    output_dir = Path(output_dir)

    # Validate directories exist
    if not backup_dir.exists():
        raise FileNotFoundError(f"Backup directory not found: {backup_dir}")
    if not backup_dir.is_dir():
        raise NotADirectoryError(f"Not a directory: {backup_dir}")
    if not output_dir.exists():
        raise FileNotFoundError(f"Output directory not found: {output_dir}")
    if not output_dir.is_dir():
        raise NotADirectoryError(f"Not a directory: {output_dir}")

    # Find highest existing backup number
    pattern = re.compile(rf"^{re.escape(backup_dir.name)}_(\d+)\.zip$")
    backup_numbers = []

    for file in output_dir.iterdir():
        if file.is_file() and (match := pattern.search(file.name)):
            backup_numbers.append(int(match.group(1)))

    # Determine backup name
    next_num = max(backup_numbers, default=0) + 1
    backup_name = f"{backup_dir.name}_{next_num}.zip"

    # Create zip file
    with zipfile.ZipFile(output_dir / backup_name, "w") as zipf:
        for directory, _, files in backup_dir.walk():
            for file in files:
                zipf.write(directory / file)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Create numbered zip backup of directory"
    )
    parser.add_argument("backup_dir", type=Path, help="Directory to backup")
    parser.add_argument(
        "-o",
        "--output-dir",
        default=Path.cwd(),
        type=Path,
        help="Directory to store backup",
    )
    args = parser.parse_args()

    try:
        zbak(args.backup_dir, args.output_dir)
    except (FileNotFoundError, NotADirectoryError) as e:
        print(f"Error: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"Unexpected error: {e}")
        sys.exit(1)
